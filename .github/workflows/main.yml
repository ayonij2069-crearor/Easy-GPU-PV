name: GPU Windows VM Setup (with RDP, Tailscale & Roblox)

on:
  workflow_dispatch:

jobs:
  setup-gpu-vm:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable Hyper-V
        shell: pwsh
        run: |
          dism.exe /Online /Enable-Feature:Microsoft-Hyper-V /All
          Write-Host "‚úÖ Hyper-V enabled."

      - name: Create Windows VM
        shell: pwsh
        run: |
          Write-Host "üñ•Ô∏è Creating Windows VM..."
          $VMName = "GPU-VM"
          $VHDPath = "C:\HyperV\$VMName.vhdx"
          $Memory = 4GB
          $CPU = 4
          $VHDSize = 60GB

          if (Get-VM -Name $VMName -ErrorAction SilentlyContinue) {
              Stop-VM -Name $VMName -Force -ErrorAction SilentlyContinue
              Remove-VM -Name $VMName -Force -ErrorAction SilentlyContinue
              Remove-Item -Path $VHDPath -Force -ErrorAction SilentlyContinue
          }

          New-VM -Name $VMName -MemoryStartupBytes $Memory -Generation 2 -NewVHDPath $VHDPath -NewVHDSizeBytes $VHDSize
          Set-VMProcessor -VMName $VMName -Count $CPU
          Write-Host "‚úÖ VM created successfully."

      - name: Start Windows VM
        shell: pwsh
        run: |
          Write-Host "‚ö° Starting the GPU VM..."
          Start-VM -Name "GPU-VM"
          Start-Sleep -Seconds 20
          Write-
