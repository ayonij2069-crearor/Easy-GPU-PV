name: Windows VM Setup (No GPU Passthrough)

on:
  workflow_dispatch:

jobs:
  setup-windows-vm:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4

      - name: Set up PowerShell
        shell: pwsh
        run: |
          Write-Host "‚úÖ PowerShell environment ready."
          Write-Host "Working Directory: $env:GITHUB_WORKSPACE"

      - name: Create VM
        shell: pwsh
        run: |
          Write-Host "üñ•Ô∏è Creating standard Windows VM..."
          $VMName = "Windows-VM"
          $VHDPath = "$env:GITHUB_WORKSPACE\$VMName.vhdx"

          # Create new VM with 4GB RAM and 4 cores
          New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -NewVHDPath $VHDPath -NewVHDSizeBytes 60GB
          Set-VMProcessor -VMName $VMName -Count 4

          Write-Host "‚úÖ VM created successfully at $VHDPath"

      - name: Configure VM Settings
        shell: pwsh
        run: |
          $VMName = "Windows-VM"
          Write-Host "‚öôÔ∏è Configuring VM settings..."
          Set-VM -Name $VMName -AutomaticStartAction StartIfRunning -AutomaticStopAction Save
          Write-Host "‚úÖ Configuration applied."

      - name: Prepare VHD
        shell: pwsh
        run: |
          $VMName = "Windows-VM"
          $VM = Get-VM -VMName $VMName
          $VHD = Get-VHD -VMId $VM.VMId

          Write-Host "üìÇ Mounting VHD to verify..."
          try {
              $Volume = Mount-VHD -Path $VHD.Path -PassThru | Get-Disk | Get-Partition | Get-Volume | Where-Object {$_.DriveLetter} | Select-Object -First 1
              Write-Host "‚úÖ Mounted successfully at drive letter: $($Volume.DriveLetter)"
          } catch {
              Write-Host "‚ö†Ô∏è VHD mount skipped or failed: $($_.Exception.Message)"
          }

          Write-Host "üîπ Dismounting VHD..."
          Dismount-VHD -Path $VHD.Path -ErrorAction SilentlyContinue

      - name: Start VM
        shell: pwsh
        run: |
          Write-Host "üöÄ Starting the VM..."
          Start-VM -Name "Windows-VM"
          Write-Host "‚úÖ VM started successfully."

      - name: Final Confirmation
        shell: pwsh
        run: |
          Write-Host "üéâ Windows VM setup completed successfully!"
